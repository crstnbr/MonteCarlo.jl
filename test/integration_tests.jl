@time @testset "MC: IsingModel Simulation" begin
    Random.seed!(123)
    m = IsingModel(dims=2, L=8);
    mc = MC(m, beta=0.35, sweeps=1000, thermalization=10);
    run!(mc, verbose=false);

    # Check measurements
    measured = measurements(mc)
    if VERSION.major == 1 && VERSION.minor == 5 # v1.5.x
        @test   25.87  ≈ measured[:Magn].M |> mean         atol=0.01
        @test    0.82  ≈ measured[:Magn].M |> std_error    atol=0.01
        @test  913.    ≈ measured[:Magn].M2 |> mean        atol=1.0
        @test   47.    ≈ measured[:Magn].M2 |> std_error   atol=1.0
        @test    0.404 ≈ measured[:Magn].m |> mean         atol=0.001
        @test    0.013 ≈ measured[:Magn].m |> std_error    atol=0.001
        @test    1.331 ≈ measured[:Magn].chi |> mean       atol=0.001

        @test  -59.55  ≈ measured[:Energy].E |> mean       atol=0.01
        @test    1.05  ≈ measured[:Energy].E |> std_error  atol=0.01
        @test 3896.    ≈ measured[:Energy].E2 |> mean      atol=1.0
        @test  136.    ≈ measured[:Energy].E2 |> std_error atol=1.0
        @test   -0.930 ≈ measured[:Energy].e |> mean       atol=0.001
        @test    0.016 ≈ measured[:Energy].e |> std_error  atol=0.001
        @test    0.66  ≈ measured[:Energy].C |> mean       atol=0.01
    else # assuming "v1.6"
        @test   25.61  ≈ measured[:Magn].M |> mean         atol=0.01
        @test    0.82  ≈ measured[:Magn].M |> std_error    atol=0.01
        @test  903.    ≈ measured[:Magn].M2 |> mean        atol=1.0
        @test   47.    ≈ measured[:Magn].M2 |> std_error   atol=1.0
        @test    0.400 ≈ measured[:Magn].m |> mean         atol=0.001
        @test    0.013 ≈ measured[:Magn].m |> std_error    atol=0.001
        @test    1.354 ≈ measured[:Magn].chi |> mean       atol=0.001

        @test  -59.10  ≈ measured[:Energy].E |> mean       atol=0.01
        @test    0.97  ≈ measured[:Energy].E |> std_error  atol=0.01
        @test 3838.    ≈ measured[:Energy].E2 |> mean      atol=1.0
        @test  125.    ≈ measured[:Energy].E2 |> std_error atol=1.0
        @test   -0.924 ≈ measured[:Energy].e |> mean       atol=0.001
        @test    0.015 ≈ measured[:Energy].e |> std_error  atol=0.001
        @test    0.66  ≈ measured[:Energy].C |> mean       atol=0.01
    end
    @test isempty(mc.configs) == true
end


@time @testset "DQMC: attractive HubbardModel Simulation" begin
    Random.seed!(123)
    m = HubbardModelAttractive(4, 2);
    N = 4*4
    mc = DQMC(m, beta=2.0, sweeps=1000, thermalization=1000, measure_rate=1);
    mc[:G]    = greens_measurement(mc, m)
    mc[:CDC]  = charge_density_correlation(mc, m)
    mc[:SDCx] = spin_density_correlation(mc, m, :x)
    mc[:SDCy] = spin_density_correlation(mc, m, :y)
    mc[:SDCz] = spin_density_correlation(mc, m, :z)
    mc[:PC]   = pairing_correlation(mc, m, K=5)
    @time run!(mc, verbose=false);

    # Check measurements
    measured = measurements(mc)
    atol = 0.05

    # hardcoded means from 10k + 100k sweeps at delta_tau = 0.05

    # Greens
    @test check([
        0.498957, -0.154395, 0.000053, -0.154416, -0.154154, 0.000141, 0.034410, 0.000210, 0.000108, 0.034333, -0.000200, 0.034306, -0.154648, -0.000083, 0.034208, 0.000085, -0.152890, 0.498639, -0.153695, 0.000091, 0.000273, -0.154036, -0.000050, 0.033964, 0.033928, 0.000006, 0.033996, -0.000136, 0.000074, -0.154045, 0.000229, 0.034132, 0.000128, -0.154022, 0.499580, -0.153634, 0.034171, 0.000025, -0.154078, 0.000146, -0.000004, 0.034092, 0.000131, 0.034072, 0.034245, -0.000105, -0.153440, -0.000119, -0.153696, 0.000080, -0.154157, 0.501049, 0.000086, 0.034123, -0.000070, -0.154196, 0.034125, -0.000081, 0.034150, 0.000055, -0.000041, 0.034279, 0.000088, -0.154186, -0.153264, 0.000371, 0.034060, 0.000245, 0.498036, -0.154372, 0.000155, -0.153932, -0.153608, 0.000092, 0.034082, 0.000201, 0.000232, 0.034094, -0.000321, 0.034104, 0.000262, -0.153699, 0.000081, 0.034058, -0.153528, 0.500891, -0.154033, 0.000206, 0.000059, -0.153755, 0.000289, 0.034010, 0.034177, -0.000105, 0.033938, -0.000036, 0.033740, 0.000082, -0.153234, -0.000050, 0.000050, -0.153561, 0.499599, -0.153333, 0.033883, -0.000045, -0.152781, -0.000036, -0.000049, 0.034155, 0.000227, 0.034133, 0.000148, 0.034225, -0.000064, -0.153766, -0.153904, 0.000017, -0.154348, 0.499199, -0.000076, 0.034137, 0.000148, -0.153761, 0.034247, 0.000029, 0.034081, 0.000019, 0.000052, 0.034184, 0.000035, 0.034163, -0.153797, 0.000044, 0.034215, 0.000005, 0.500607, -0.154214, 0.000131, -0.154038, -0.154267, -0.000143, 0.034096, -0.000078, 0.033862, -0.000138, 0.034106, -0.000017, 0.000144, -0.154080, 0.000050, 0.034031, -0.153451, 0.498722, -0.153177, 0.000093, -0.000084, -0.153991, 0.000129, 0.034177, -0.000130, 0.034281, 0.000006, 0.034198, 0.034250, 0.000166, -0.154725, 0.000197, 0.000084, -0.154542, 0.498484, -0.154350, 0.034178, -0.000020, -0.154121, -0.000026, 0.034039, -0.000125, 0.034244, -0.000080, 0.000145, 0.034210, 0.000123, -0.154070, -0.153918, 0.000131, -0.153565, 0.500541, 0.000031, 0.034289, 0.000287, -0.154012, -0.153298, 0.000064, 0.034199, 0.000129, 0.000237, 0.034193, -0.000130, 0.034159, -0.153641, -0.000098, 0.034004, 0.000039, 0.499920, -0.153995, 0.000098, -0.154059, 0.000059, -0.154089, -0.000253, 0.034143, 0.034101, 0.000048, 0.034257, 0.000005, -0.000129, -0.154156, 0.000003, 0.034052, -0.153945, 0.501709, -0.153576, -0.000164, 0.034110, 0.000164, -0.154301, 0.000288, -0.000214, 0.034268, 0.000260, 0.034275, 0.034270, 0.000093, -0.153669, 0.000238, 0.000065, -0.154439, 0.499976, -0.154191, 0.000088, 0.034170, -0.000178, -0.153559, 0.034077, 0.000021, 0.034207, -0.000004, -0.000100, 0.034081, -0.000005, -0.153590, -0.154030, -0.000257, -0.153332, 0.498969
    ], (measured[:G] |> mean)[:], atol)
    @test check([
        0.01903630965131304, 0.005367516479841765, 0.0024584912434881534, 0.004890991356523148, 0.006363727124689783, 0.002670798811073267, 0.0021066937139101443, 0.00301559391676348, 0.003194080063641578, 0.0013442384852690233, 0.0021844921675267036, 0.0017208532918349584, 0.004902256544938516, 0.003022457879188603, 0.001959177525541325, 0.0023162054411693, 0.004275338756144313, 0.016190447778031265, 0.00622439056707409, 0.0027891086921042144, 0.0024747787231799347, 0.004743929829605756, 0.0026022570507337954, 0.0018811623274672816, 0.0020296410229540124, 0.001917007923316469, 0.0017821822872064257, 0.0015874651085898946, 0.002073785126319732, 0.005203727105701843, 0.0024428864285170842, 0.0014482403743486525, 0.002732283686976738, 0.006241513316141949, 0.017947118144596073, 0.0066844610214952535, 0.002073388696305197, 0.0026748418574992702, 0.006343349608775392, 0.002119334209726534, 0.0019276798962566477, 0.001912086325670065, 0.0027078659347968587, 0.0017274987770035345, 0.001730730946599209, 0.002755975555112104, 0.0062626591213190445, 0.002538493010301427, 0.006098666836121245, 0.002351234708256203, 0.007537561825151221, 0.01482652736208729, 0.002226492682037637, 0.0018870261129214604, 0.0028813646224384037, 0.0056738286375110775, 0.001978694193790825, 0.0015194200298218336, 0.0018930490650442217, 0.002954208794234731, 0.002539403264143692, 0.002043787453315343, 0.002465116172071212, 0.00633723160781742, 0.005152182403326165, 0.00221980109044263, 0.00209307523188663, 0.002279203611722848, 0.01727462737987002, 0.006193953525747859, 0.0022950804203056424, 0.00605660516317818, 0.0056744842883902765, 0.0021411097877753606, 0.0015106572026585446, 0.002285965572601132, 0.0025851060623688572, 0.0019413813197430884, 0.0018293773252474807, 0.0018633913153026519, 0.0023424483738403476, 0.00560666781142671, 0.0028486833567268675, 0.0018996697083859427, 0.006778416349325631, 0.015529197915268668, 0.005802396675855519, 0.002577418620315891, 0.002537373388636465, 0.004267295023739163, 0.002216982496441896, 0.0014470288731124991, 0.0015448157761172826, 0.0026749909170203207, 0.0015960502414737114, 0.0018638971133579443, 0.002176172975333444, 0.0024661226628342214, 0.0059976529594891895, 0.0024275919659689023, 0.0024874460957389284, 0.004866152879901385, 0.016989888842258615, 0.00606786788834373, 0.0023650404715101145, 0.0022059530709299794, 0.006279985224570244, 0.0022591078220764883, 0.002244262826955961, 0.0017607727293324292, 0.002805151032378269, 0.0019203802814192405, 0.002808211640591048, 0.0014493790069284944, 0.0026815107294531825, 0.005244751689767846, 0.004457555716976892, 0.0027461862709045517, 0.007432682630957972, 0.01755180302734928, 0.0027546143757098953, 0.0013564156087778078, 0.002707184989403521, 0.005099207586692647, 0.00150711950287787, 0.0018469456135621182, 0.0021664965287707533, 0.0028573759197268573, 0.002257562058149153, 0.0018752987165948749, 0.0018474643382295432, 0.0015607159782713032, 0.004821113270875764, 0.002364393502281104, 0.0015914287961616067, 0.002017966865185779, 0.016678090766298847, 0.005532950615319388, 0.0025109463649847317, 0.00490999391748333, 0.005540189949851306, 0.0025778872950522782, 0.0015297393649903565, 0.0021526364720696263, 0.0015571786088503922, 0.0030715698656264088, 0.0019442247942314111, 0.001959609115393741, 0.002451806750645247, 0.00559182183037939, 0.002364438409286417, 0.002033163891428257, 0.007385122100593753, 0.016250001923804477, 0.00588029391580204, 0.0022664676364664562, 0.0022713083805696375, 0.004920463385631935, 0.002555556649254254, 0.0024253973749420706, 0.0016998977444620306, 0.0023730453964623094, 0.0026884831369355915, 0.002052298758092647, 0.0017405567697183519, 0.0025459146940258817, 0.006477775129878893, 0.0027559441428842125, 0.002507883713380407, 0.005579200483908438, 0.015149687637628374, 0.005716157182003588, 0.0020198143514409796, 0.002678143865896058, 0.005627834489234238, 0.0019505457843814742, 0.0015667358381430906, 0.0019693925268430904, 0.0017634657213137022, 0.0027309321641583004, 0.0023192160020215594, 0.001492816198492005, 0.002785975799730211, 0.005637866774905859, 0.007373646876499863, 0.0024441882113822207, 0.005057050695680436, 0.016981962144626644, 0.0026358465926791313, 0.0021629519326452178, 0.001978862212401592, 0.00559129466697721, 0.0053878998822222395, 0.002378047860973303, 0.0021696210935349316, 0.0021858413712564696, 0.002603168942043464, 0.0018142457233731126, 0.0019318206065561722, 0.0016916601775288252, 0.006462811051987628, 0.0023964206261950405, 0.00201234725665299, 0.0020856386696421355, 0.01818721557230035, 0.0078336450885551, 0.002879127598649167, 0.005559421935709471, 0.0025272247116726937, 0.006749213317453175, 0.002407881174684203, 0.001723770533529353, 0.001685814864352903, 0.002595017712103584, 0.001784867442122867, 0.0016512832001637893, 0.0029511346895967168, 0.004831990577677809, 0.002363895478273945, 0.0017365815749286698, 0.0061205221823493194, 0.017463498150406046, 0.006898041663060922, 0.002930549060657847, 0.0013097885169025025, 0.002477957003239124, 0.005041328409858466, 0.0022703149157202326, 0.0017091772829437746, 0.0014423544812366467, 0.0026124944984324892, 0.0017586921671544939, 0.0018143303377610813, 0.001981021736540454, 0.005538479554528282, 0.0015071193020268251, 0.0023646394774796474, 0.005869543468904877, 0.01732179843958681, 0.004853138482281587, 0.0019211890883876162, 0.0019921005132619825, 0.0029311927912516376, 0.005390881176746915, 0.0014190304988554389, 0.0018902190049541409, 0.0023298593140222215, 0.0024414631574547737, 0.0025022457477321563, 0.001662072259828581, 0.0022766455352105424, 0.0052142514926209705, 0.005934479064251144, 0.002908842935009184, 0.006626344451829513, 0.017266063739950332
    ], (measured[:G] |> std_error)[:], atol)

    # Charge Density Correlation
    @test check([
        1.559723, 0.947929, 0.947920, 0.947929, 0.947920, 1.002382, 1.002578, 1.002382, 1.002578, 1.002973, 1.002722, 0.998367, 0.998192, 0.998192, 0.998367, 1.002403
    ], mean(measured[:CDC]), atol)
    @test check([
        0.013869638657504228, 0.013470915194620922, 0.013282700278496358, 0.013470915194621087, 0.013282700278496358, 0.013550942726610091, 0.014307471098069393, 0.014492552221530538, 0.014129517405169136, 0.01449255222153069, 0.014307471098069393, 0.013948472512305249, 0.01394847251230509, 0.01389084520478554, 0.01389084520478546, 0.013133272694007561
    ], std_error(measured[:CDC]), atol)

    # Spin density correlations (x, y, z)
    @test check([
        0.441557, -0.043403, -0.043389, -0.043403, -0.043389, -0.000937, -0.000938, -0.000937, -0.000938, -0.000940, -0.000942, -0.002002, -0.002002, -0.002002, -0.002002, -0.000530
    ], mean(measured[:SDCx]), atol)
    @test check([
        0.0015350907401287547, 0.0002368878415500336, 0.0002607507287443457, 0.0002368878415500336, 0.00026075072874433736, 6.64636472973452e-5, 2.9316744933934093e-5, 3.521865202114811e-5, 6.282380159287888e-5, 3.521865202114811e-5, 2.931674493393406e-5, 2.5828399958572843e-5, 2.5828399958573172e-5, 2.7096518574704045e-5, 2.7096518574704045e-5, 2.605149773144738e-5
    ], std_error(measured[:SDCx]), atol)
    @test check([
        0.441557, -0.043403, -0.043389, -0.043403, -0.043389, -0.000937, -0.000938, -0.000937, -0.000938, -0.000940, -0.000942, -0.002002, -0.002002, -0.002002, -0.002002, -0.000530
    ], mean(measured[:SDCy]), atol)
    @test check([
        0.0015350907401287547, 0.0002368878415500336, 0.0002607507287443457, 0.0002368878415500336, 0.00026075072874433736, 6.64636472973452e-5, 2.9316744933934093e-5, 3.521865202114811e-5, 6.282380159287888e-5, 3.521865202114811e-5, 2.931674493393406e-5, 2.5828399958572843e-5, 2.5828399958573172e-5, 2.7096518574704045e-5, 2.7096518574704045e-5, 2.605149773144738e-5
    ], std_error(measured[:SDCy]), atol)
    @test check([
        0.441557, -0.043403, -0.043389, -0.043403, -0.043389, -0.000937, -0.000938, -0.000937, -0.000938, -0.000940, -0.000942, -0.002002, -0.002002, -0.002002, -0.002002, -0.000530
    ], mean(measured[:SDCz]), atol)
    @test check([
        0.0015350907401287547, 0.00023688784155001527, 0.00026075072874433736, 0.00023688784155001527, 0.0002607507287443457, 6.64636472973453e-5, 2.9316744933933842e-5, 3.521865202114802e-5, 6.282380159287893e-5, 3.521865202114805e-5, 2.931674493393381e-5, 2.58283999585735e-5, 2.5828399958572843e-5, 2.7096518574704045e-5, 2.7096518574704357e-5, 2.605149773144732e-5
    ], std_error(measured[:SDCz]), atol)

    # Pairing Correlations
    @test check([
        0.278901, 0.026748, 0.026731, 0.026735, 0.026738, 0.000645, 0.000645, 0.000644, 0.000645, 0.000646, 0.000649, 0.001480, 0.001480, 0.001480, 0.001479, 0.000368, -0.076903, -0.076920, -0.000011, -0.000007, -0.000010, -0.000008, 0.000002, 0.000003, -0.000009, -0.000007, 0.000003, 0.000001, 0.000001, -0.000003, 0.000002, -0.000003, -0.076893, -0.000007, -0.076900, -0.000010, -0.000011, -0.000005, -0.000011, 0.000003, 0.000002, 0.000002, -0.000012, 0.000001, 0.000001, 0.000003, -0.000003, -0.000003, -0.076920, -0.000007, -0.000008, -0.076903, -0.000009, 0.000001, -0.000011, -0.000010, 0.000002, -0.000007, 0.000001, 0.000002, -0.000003, 0.000003, 0.000003, -0.000003, -0.076900, -0.000005, -0.000012, -0.000011, -0.076893, 0.000001, 0.000003, -0.000010, -0.000007, 0.000001, -0.000011, -0.000003, 0.000002, 0.000003, 0.000002, -0.000003, -0.076905, -0.000012, -0.000009, -0.076881, -0.000014, 0.000001, -0.000009, -0.000013, 0.000003, -0.000010, 0.000003, 0.000003, -0.000003, 0.000003, 0.000004, -0.000003, 0.247193, 0.022671, 0.023848, 0.022669, 0.023849, 0.000062, 0.000063, 0.000062, 0.000062, 0.000219, -0.000080, 0.001106, 0.001156, 0.001156, 0.001106, 0.000061, -0.001087, -0.005200, 0.022667, 0.022664, -0.005202, 0.000063, -0.001086, 0.000062, -0.000011, 0.000063, 0.000062, -0.005200, 0.001156, -0.005203, 0.001156, -0.000011, -0.001095, 0.023853, -0.005200, 0.021701, -0.005200, -0.000076, 0.000216, 0.000216, -0.000078, -0.001093, -0.000009, -0.005200, 0.001215, 0.001106, -0.005200, -0.000009, -0.001098, -0.005201, -0.005202, 0.022667, 0.022666, -0.000010, 0.000061, -0.001088, 0.000063, 0.000062, 0.000061, 0.001156, 0.001156, -0.005203, -0.005200, -0.000010, -0.076892, -0.000006, -0.000013, -0.000012, -0.076889, 0.000001, 0.000002, -0.000015, -0.000011, 0.000002, -0.000012, -0.000003, 0.000002, 0.000003, 0.000003, -0.000003, -0.001087, 0.022671, -0.005204, -0.005202, 0.022667, 0.000061, -0.000011, 0.000061, -0.001084, 0.000062, 0.000061, 0.001156, -0.005202, 0.001155, -0.005202, -0.000011, 0.247187, 0.023860, 0.022668, 0.023852, 0.022665, 0.000061, 0.000061, 0.000061, 0.000061, -0.000080, 0.000217, 0.001156, 0.001106, 0.001106, 0.001155, 0.000061, -0.001096, -0.005202, -0.005202, 0.022670, 0.022668, -0.000010, 0.000061, -0.001083, 0.000063, 0.000062, 0.000062, 0.001156, 0.001156, -0.005203, -0.005200, -0.000010, -0.001096, -0.005203, 0.023855, -0.005203, 0.021695, -0.000079, -0.000079, 0.000216, 0.000216, -0.000010, -0.001094, 0.001214, -0.005203, -0.005202, 0.001105, -0.000010, -0.076881, -0.076905, -0.000009, -0.000010, -0.000013, -0.000009, 0.000003, 0.000004, -0.000014, -0.000012, 0.000003, 0.000001, 0.000003, -0.000003, 0.000003, -0.000003, -0.001093, 0.021701, -0.005200, 0.023853, -0.005200, 0.000216, -0.000076, -0.000078, 0.000216, -0.001095, -0.000009, -0.005200, 0.001106, 0.001215, -0.005200, -0.000009, -0.001088, 0.022666, 0.022667, -0.005200, -0.005203, -0.001098, 0.000062, -0.000010, 0.000061, 0.000063, 0.000061, -0.005201, -0.005202, 0.001156, 0.001156, -0.000010, 0.247193, 0.022671, 0.023848, 0.022669, 0.023849, 0.000062, 0.000063, 0.000062, 0.000062, 0.000219, -0.000080, 0.001106, 0.001156, 0.001156, 0.001106, 0.000061, -0.001086, 0.022667, -0.005203, -0.005200, 0.022664, 0.000062, -0.000011, 0.000063, -0.001087, 0.000063, 0.000062, 0.001156, -0.005202, 0.001156, -0.005200, -0.000011, -0.076889, -0.000011, -0.076892, -0.000015, -0.000012, -0.000006, -0.000012, 0.000003, 0.000002, 0.000003, -0.000013, 0.000002, 0.000001, 0.000002, -0.000003, -0.000003, -0.001083, 0.022668, 0.022670, -0.005200, -0.005203, -0.001096, 0.000062, -0.000010, 0.000062, 0.000063, 0.000061, -0.005202, -0.005202, 0.001156, 0.001156, -0.000010, -0.001094, -0.005203, 0.021695, -0.005202, 0.023855, 0.000216, 0.000216, -0.000079, -0.000079, -0.000010, -0.001096, 0.001105, -0.005203, -0.005203, 0.001214, -0.000010, -0.001084, -0.005202, 0.022671, 0.022667, -0.005202, 0.000062, -0.001087, 0.000061, -0.000011, 0.000061, 0.000061, -0.005202, 0.001156, -0.005204, 0.001155, -0.000011, 0.247187, 0.023860, 0.022668, 0.023852, 0.022665, 0.000061, 0.000061, 0.000061, 0.000061, -0.000080, 0.000217, 0.001156, 0.001106, 0.001106, 0.001155, 0.000061
    ], mean(measured[:PC])[:], atol)
    @test check([
        0.0032863968694560874, 0.00042772252675633826, 0.0003518557357542367, 0.0004743615772443992, 0.0003187801835120089, 4.807866876266873e-5, 2.7443632781155007e-5, 3.087921747910029e-5, 4.295229784612734e-5, 2.7131480773117706e-5, 2.3360145651071746e-5, 4.6038701058516214e-5, 5.688082298878186e-5, 3.477280028969865e-5, 3.0122652022979076e-5, 2.028509759307593e-5, 0.0006793221509329129, 0.0006754871522655642, 0.00011843270443530931, 0.00011834451604052362, 0.00010615690256295016, 0.0001243664358098925, 0.00011105578571808066, 0.00012160922087931815, 2.8535027637957004e-5, 2.7566801509094677e-5, 2.1371276153817884e-5, 2.6505038538425558e-5, 2.4270303829044734e-5, 2.7585721128230576e-5, 3.5578032465851165e-5, 3.792786779387757e-5, 0.0006820245874155875, 0.00011194387420314651, 0.0006431256216668431, 0.00010798281383960798, 0.00011839952161819387, 2.747026452012285e-5, 0.00012140889313203758, 2.6049298318322218e-5, 0.00011433387417751547, 0.00012556056981436842, 2.3905752587305103e-5, 2.509640204375193e-5, 3.635761848562791e-5, 2.465954105096387e-5, 2.5137728666196422e-5, 3.594115483339847e-5, 0.000675487152265577, 0.0001243664358098925, 0.00011105578571808066, 0.0006793221509329129, 0.00012160922087931817, 0.00011834451604052362, 2.6505038538425558e-5, 2.4270303829044734e-5, 2.7585721128230576e-5, 0.00011843270443530931, 0.00010615690256295016, 2.7566801509094677e-5, 2.1371276153817884e-5, 3.792786779387757e-5, 2.8535027637957007e-5, 3.5578032465851165e-5, 0.0006431256216668431, 0.00012140889313203759, 0.00011433387417751547, 0.00012556056981436842, 0.0006820245874155747, 2.509640204375193e-5, 2.465954105096387e-5, 0.00011194387420314651, 0.00011839952161819387, 2.5137728666196422e-5, 0.00010798281383960797, 3.594115483339846e-5, 2.7470264520122846e-5, 2.6049298318322218e-5, 2.3905752587305103e-5, 3.6357618485627904e-5, 0.0005712777277038281, 0.00011138201020643361, 0.00011547593940896772, 0.0006185946733805882, 0.0001250322089856034, 0.00011099025943433941, 2.2911566901869562e-5, 2.7069997775801493e-5, 2.547577645224039e-5, 0.00011394307751195347, 0.00011775034186131933, 2.516833737154611e-5, 2.5865813768100625e-5, 3.5584130541739836e-5, 2.4073549197964844e-5, 3.3867429395236943e-5, 0.003539859671041112, 0.00016362767390622782, 0.0002246191699138663, 0.00017845343617490725, 0.00021268203128181403, 3.8944094417145216e-5, 1.1728571613108348e-5, 1.1083582357649566e-5, 3.267501471471958e-5, 1.2586212552108007e-5, 1.0841571469820574e-5, 2.0426518109442387e-5, 2.0692330560425303e-5, 2.198816223405185e-5, 2.075131248696356e-5, 1.4831088536320838e-5, 0.0003515926250209984, 8.364142899254581e-5, 0.00014397768229978744, 0.00015017652713828134, 6.957343027475577e-5, 1.2452188285585125e-5, 1.239432966071291e-5, 1.170251699251169e-5, 1.2510294872646639e-5, 0.00035642112923309986, 1.118906729995006e-5, 7.789029219399845e-5, 2.226663792917963e-5, 2.036813610782931e-5, 6.491932854948363e-5, 1.3179372854946754e-5, 0.0003739027082114623, 0.00024321517489145862, 6.247968326554638e-5, 0.00011844392077501222, 6.85233902257041e-5, 0.0003876668716336736, 1.8169742082622794e-5, 2.0000420131148687e-5, 1.6304784801120634e-5, 1.8452438168822835e-5, 1.9947241100376264e-5, 6.670410552204984e-5, 6.65542070420358e-5, 2.4596544124544127e-5, 1.96976597592882e-5, 1.6180256909043756e-5, 0.0003515376320593395, 7.232255697701556e-5, 7.068637292329068e-5, 0.00015234503654893702, 0.00015095582137596026, 1.4494089296318829e-5, 1.227868057837655e-5, 1.3777969885874737e-5, 1.3804986335903444e-5, 1.1115952291683665e-5, 0.0003455496357607849, 2.1224866990386695e-5, 7.8317894232434e-5, 2.0719827570342864e-5, 6.534385175842493e-5, 1.1001207962411203e-5, 0.0006235602912179505, 0.00011871663414839694, 0.00012212270640311318, 0.00011953805525290922, 0.000620221577511302, 2.3188118242046084e-5, 2.7692702639765495e-5, 0.00011079105994197718, 0.0001158178029217961, 2.4528820820853455e-5, 0.00012000417025520125, 3.5920923142131966e-5, 2.500081224729451e-5, 2.866707037909041e-5, 2.594548700031861e-5, 3.595985463636785e-5, 0.0003759489283794092, 0.00014814065865731806, 7.202950072343839e-5, 7.270595014281034e-5, 0.00014942849039939674, 1.4941393663445203e-5, 1.4004128039011912e-5, 0.0003352754974847287, 1.2861788315205813e-5, 1.5430611673346766e-5, 1.2180076096398397e-5, 2.246155755059947e-5, 7.752875372782713e-5, 7.116360379326014e-5, 2.172539102064846e-5, 1.220029529846814e-5, 0.003582411455132999, 0.0002825484222289856, 0.00018099728215045593, 0.0003012407141657386, 0.00017876709707790486, 3.915089723405503e-5, 1.2658245820587652e-5, 1.2771479152914011e-5, 3.2790573680904847e-5, 1.297033650205429e-5, 1.0730709603946599e-5, 2.76191232435535e-5, 2.8418952423800635e-5, 2.143839940531424e-5, 2.000220367457017e-5, 1.6179065936505336e-5, 0.0003489193143297205, 7.455741065724246e-5, 6.928355385121493e-5, 0.00015452264028963485, 0.00015484581765932366, 1.2996421657299983e-5, 1.3936851912543852e-5, 1.2758762469247603e-5, 1.3025773586153131e-5, 1.288541383164654e-5, 0.00032266596637020817, 2.168642281079922e-5, 7.852068318219601e-5, 2.2004304032514555e-5, 6.674635580332466e-5, 1.307995089540432e-5, 0.00037025964275628185, 7.432900732372818e-5, 0.00023730774991964098, 7.765883516354168e-5, 0.00013037536437217285, 2.0332637110704405e-5, 1.87160378916926e-5, 2.0473022691921813e-5, 0.0003660098090677224, 2.0992174207137846e-5, 2.155902062952222e-5, 3.961712150627199e-5, 2.3168964349629955e-5, 7.398702065306552e-5, 7.433944300255508e-5, 1.855683938692942e-5, 0.0006185946733805882, 0.0005712777277038281, 0.00011394307751195347, 0.00011099025943433941, 0.00011775034186131933, 0.00011138201020643361, 0.00011547593940896772, 0.0001250322089856034, 2.4073549197964844e-5, 2.516833737154611e-5, 2.5865813768100625e-5, 2.2911566901869562e-5, 2.7069997775801493e-5, 2.547577645224039e-5, 3.3867429395236943e-5, 3.5584130541739836e-5, 0.00038766687163367355, 0.0001184439207750168, 6.670410552204831e-5, 0.00024321517489145862, 6.655420704203732e-5, 0.0003739027082114623, 1.845243816882282e-5, 1.9947241100376264e-5, 1.6180256909043756e-5, 1.8169742082622794e-5, 2.0000420131148687e-5, 6.2479683265548e-5, 6.852339022570557e-5, 1.96976597592882e-5, 2.4596544124543955e-5, 1.6304784801120634e-5, 0.0003455496357607849, 0.0001509558213759674, 0.00015234503654893702, 7.8317894232434e-5, 6.53438517584244e-5, 1.3777969885874739e-5, 0.0003515376320593395, 1.3804986335903442e-5, 1.1115952291683665e-5, 1.449408929631883e-5, 1.1001207962411203e-5, 7.232255697701509e-5, 2.0719827570343067e-5, 7.068637292328972e-5, 2.1224866990386895e-5, 1.227868057837655e-5, 0.003539859671041112, 0.00016362767390622782, 0.00022461916991386148, 0.0001784534361749194, 0.00021268203128181403, 3.894409441714523e-5, 1.1728571613108352e-5, 1.1083582357649566e-5, 3.2675014714719584e-5, 1.2586212552108007e-5, 1.0841571469820574e-5, 2.0426518109442387e-5, 2.0692330560425506e-5, 2.198816223405185e-5, 2.075131248696356e-5, 1.4831088536320838e-5, 0.00035642112923309986, 0.00014397768229979497, 6.491932854948468e-5, 7.789029219399845e-5, 0.00015017652713828134, 1.239432966071291e-5, 1.2510294872646642e-5, 0.0003515926250209984, 1.118906729995006e-5, 1.3179372854946755e-5, 1.2452188285585125e-5, 2.03681361078291e-5, 8.3641428992545e-5, 6.957343027475577e-5, 2.226663792917944e-5, 1.170251699251169e-5, 0.000620221577511302, 0.00011079105994197718, 0.0006235602912179505, 0.00012000417025520125, 0.0001158178029217961, 2.500081224729451e-5, 0.00011871663414839694, 2.866707037909041e-5, 0.00012212270640311318, 0.00011953805525290922, 2.594548700031861e-5, 2.3188118242046084e-5, 3.595985463636785e-5, 2.7692702639765495e-5, 2.4528820820853455e-5, 3.5920923142131966e-5, 0.0003226659663702083, 0.00015484581765932366, 0.0001545226402896208, 7.852068318219601e-5, 6.674635580332466e-5, 1.2758762469247605e-5, 0.0003489193143297205, 1.3025773586153133e-5, 1.2885413831646546e-5, 1.2996421657299983e-5, 1.307995089540432e-5, 7.455741065724246e-5, 2.2004304032514555e-5, 6.92835538512154e-5, 2.168642281079922e-5, 1.3936851912543852e-5, 0.00036600980906772247, 7.398702065306415e-5, 0.00013037536437217285, 7.433944300255508e-5, 0.0002373077499196364, 1.855683938692942e-5, 2.047302269192182e-5, 1.8716037891692603e-5, 0.00037025964275628185, 2.155902062952222e-5, 2.0992174207137846e-5, 2.3168964349629955e-5, 3.961712150627209e-5, 7.432900732372909e-5, 7.765883516354168e-5, 2.0332637110704405e-5, 0.0003352754974847287, 7.752875372782625e-5, 0.00014814065865731074, 0.000149428490399404, 7.11636037932587e-5, 1.2180076096398397e-5, 1.4941393663445203e-5, 1.2200295298468141e-5, 1.4004128039011908e-5, 0.00037594892837940913, 1.2861788315205815e-5, 7.270595014281173e-5, 2.172539102064846e-5, 2.246155755059975e-5, 7.202950072343933e-5, 1.5430611673346766e-5, 0.003582411455132999, 0.0002825484222289856, 0.00018099728215046192, 0.0003012407141657386, 0.00017876709707790486, 3.9150897234055034e-5, 1.2658245820587652e-5, 1.2771479152914011e-5, 3.279057368090484e-5, 1.297033650205429e-5, 1.0730709603946597e-5, 2.7619123243553578e-5, 2.841895242380056e-5, 2.143839940531424e-5, 2.0002203674570274e-5, 1.6179065936505336e-5
    ], std_error(measured[:PC])[:], atol)
end



@time @testset "DQMC: repulsive HubbardModel Simulation" begin
    Random.seed!(123)
    m = HubbardModelRepulsive(2, 2);
    mc = DQMC(m, beta=2.0, sweeps=1000, thermalization=1000, measure_rate=1);
    mc[:G]    = greens_measurement(mc, m)
    mc[:CDC]  = charge_density_correlation(mc, m)
    mc[:Mx]   = magnetization(mc, m, :x)
    mc[:My]   = magnetization(mc, m, :y)
    mc[:Mz]   = magnetization(mc, m, :z)
    mc[:SDCx] = spin_density_correlation(mc, m, :x)
    mc[:SDCy] = spin_density_correlation(mc, m, :y)
    mc[:SDCz] = spin_density_correlation(mc, m, :z)
    mc[:PC]   = pairing_correlation(mc, m, K=3)
    run!(mc, verbose=false);

    # Check measurements
    measured = measurements(mc)
    atol = 0.05

    # Greens
    @test [
        0.499896, -0.249412, -0.248547, 0.001101, 0.000000, 0.000000, 0.000000, 0.000000, -0.249144, 0.501226, -0.000068, -0.249244, 0.000000, 0.000000, 0.000000, 0.000000, -0.249515, -0.000893, 0.499410, -0.249425, 0.000000, 0.000000, 0.000000, 0.000000, 0.000720, -0.249229, -0.247895, 0.498638, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.500104, -0.249144, -0.249515, -0.000720, 0.000000, 0.000000, 0.000000, 0.000000, -0.249412, 0.498774, 0.000893, -0.249229, 0.000000, 0.000000, 0.000000, 0.000000, -0.248547, 0.000068, 0.500590, -0.247895, 0.000000, 0.000000, 0.000000, 0.000000, -0.001101, -0.249244, -0.249425, 0.501362
    ] ≈ (measured[:G] |> mean)[:]  atol = 0.1
    @test [
        0.015558677710177986 0.008330899904555777 0.008184425352547245 0.009154682712334604 0.0 0.0 0.0 0.0; 0.007410831061669652 0.01648129284257949 0.008625434463440258 0.007294508374789638 0.0 0.0 0.0 0.0; 0.006843413476789877 0.008445936622654146 0.013787211108014254 0.008058662653954283 0.0 0.0 0.0 0.0; 0.009844147766786396 0.008848693062785571 0.008838191580658811 0.020082028056368488 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.01555867771017795 0.007410831061669576 0.0068434134767897965 0.009844147766786278; 0.0 0.0 0.0 0.0 0.008330899904555801 0.01648129284257949 0.008445936622654148 0.008848693062785485; 0.0 0.0 0.0 0.0 0.008184425352547372 0.008625434463440267 0.013787211108014214 0.008838191580658834; 0.0 0.0 0.0 0.0 0.009154682712334624 0.007294508374789657 0.008058662653954276 0.020082028056368446
    ] ≈ measured[:G] |> std_error      atol = atol

    # Charge Density Correlation
    @test [
        1.442123, 0.884519, 0.884452, 0.976506
    ] ≈ mean(measured[:CDC]) atol = atol
    @test [
        0.002734862709277855, 0.0011120013039444745, 0.0010697404888432946, 0.0011271551926820696
    ][:] ≈ std_error(measured[:CDC]) atol = atol

    # Magnetization
    @test [
        0.0, 0.0, 0.0, 0.0
    ] ≈ mean(measured[:Mx])        atol = atol
    @test [
        0.0, 0.0, 0.0, 0.0
    ] ≈ std_error(measured[:Mx])   atol = atol
    @test [
        0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im
    ] ≈ mean(measured[:My])        atol = atol
    @test [
        0.0, 0.0, 0.0, 0.0
    ] ≈ std_error(measured[:My])   atol = atol
    @test [
        0.02, -0.02, -0.04, 0.00 # should this be 0 with error?
    ] ≈ mean(measured[:Mz]) atol = atol
    @test [
        0.0053949097720738, 0.007015652647519458, 0.007894887156482287, 0.007525414225664361
    ] ≈ std_error(measured[:Mz]) atol = atol

    # Spin density correlations (x, y, z)
    @test [
        0.557877, -0.139454, -0.139804, 0.030304
    ] ≈ mean(measured[:SDCx]) atol = atol
    @test [
        0.0027348627092750135, 0.002691219601002444, 0.002555831150492111, 0.0013440578305848455
    ][:] ≈ std_error(measured[:SDCx]) atol = atol
    @test [
        0.557877, -0.139454, -0.139804, 0.030304
    ] ≈ mean(measured[:SDCy]) atol = atol
    @test [
        0.0027348627092750135, 0.002691219601002444, 0.002555831150492111, 0.0013440578305848455
    ][:] ≈ std_error(measured[:SDCy]) atol = atol
    @test [
        0.557877, -0.139273, -0.139662, 0.030327
    ] ≈ mean(measured[:SDCz]) atol = atol
    @test [
        0.0027348627092748106, 0.00791852904864558, 0.007824969460855756, 0.006651107663992822
    ][:] ≈ std_error(measured[:SDCz]) atol = atol

    # Pairing Correlations
    @test [
        0.221061, 0.057740, 0.057774, -0.011747, -0.124435, -0.124531, 0.000064, -0.000029, -0.124539, 0.000081, -0.124630, -0.000032, -0.124437, -0.124534, 0.000029, -0.000064, 0.255948, 0.069727, 0.059859, -0.001775, 0.001648, 0.063452, 0.063422, 0.001848, -0.124504, 0.000032, -0.124595, -0.000081, 0.001632, 0.063422, 0.063452, 0.001863, 0.256029, 0.059847, 0.069902, -0.001776
    ] ≈ mean(measured[:PC])[:] atol = atol
    @test [
        0.001367431354637659, 0.0005560006519724946, 0.0005348702444204311, 0.0005635775963397751, 0.002483170888063298, 0.0019995138471234027, 0.0016765856228872162, 0.0017201184012394855, 0.002131747013786726, 0.0017425693779002111, 0.0022456690936882052, 0.0017307653829596891, 0.002243883064771306, 0.002225762938342551, 0.001720118401239482, 0.0016765856228872218, 0.001947254588881961, 0.001345609800501222, 0.0007977932487371304, 0.0007110834841664547, 0.003803528962932711, 0.0007363554205369239, 0.0007285186026716149, 0.003882312744872355, 0.002142487249272225, 0.0017307653829596863, 0.002077188962229575, 0.0017425693779002172, 0.0038833853421802026, 0.000728518602671597, 0.0007363554205368886, 0.00393584111062321, 0.001906193690791037, 0.0008143580947866242, 0.0012779155752460556, 0.0007228031157513561
    ] ≈ std_error(measured[:PC])[:] atol = atol
end